stages:
  - testbench
  - build
  - emulation
  - synth

variables:
  ACCOUNT: "hpc-prf-cifi"
  SCHEDULER_PARAMETERS: "-A ${ACCOUNT} -p normal -t 00:30:00 -n 4 --mem 16g"
  SYNTH_SCHEDULER_PARAMETERS: "-A ${ACCOUNT} -p normal -q fpgasynthesis -t 4:00:00 -n 1 --mem 64g --cpus-per-task=64"

default:
  id_tokens:
    CI_JOB_JWT:
      aud: https://git.uni-paderborn.de
  tags:
    - slurm
  before_script:
    - source env.sh

tb:nfc:
  stage: testbench
  script:
    - make run_nfc_tb
  only:
    changes:
      - rtl/aurora_hls_nfc.v
      - rtl/aurora_hls_nfc_tb.v
      - tcl/run_nfc_tb.tcl
      - .gitlab-ci.yml
  artifacts:
    paths:
      - nfc_tb.vcd
      - nfc_tb.wdb

tb:crc_counter:
  stage: testbench
  script:
    - make run_crc_counter_tb
  only:
    changes:
      - rtl/aurora_hls_crc_counter.v
      - rtl/aurora_hls_crc_counter_tb.v
      - tcl/run_crc_counter_tb.tcl
      - .gitlab-ci.yml
  artifacts:
    paths:
      - crc_counter_tb.vcd
      - crc_counter_tb.wdb

tb:configuration:
  stage: testbench
  script:
    - make run_configuration_tb
  only:
    changes:
      - rtl/aurora_hls_configuration.v
      - rtl/aurora_hls_configuration_tb.v
      - tcl/run_configuration_tb.tcl
      - .gitlab-ci.yml
  artifacts:
    paths:
      - configuration_tb.vcd
      - configuration_tb.wdb

build:host:
  stage: build
  script:
    - make host
  artifacts:
    paths:
      - ./host_aurora_hls_test

build:emulation_xclbin:
  stage: build
  script:
    - make xclbin TARGET=sw_emu
  artifacts:
    paths:
      - ./aurora_hls_test_sw_emu.xclbin

build:hlslib_test:
  stage: build
  script:
    - cd emulation/test
    - mkdir build
    - cd build
    - cmake ..
    - make
  only:
    changes:
      - emulation/**
      - .gitlab-ci.yml
  artifacts:
    paths:
      - emulation/test/build/aurora_emu_test

build:hlslib_example:
  stage: build
  script:
    - cd emulation/example
    - mkdir build
    - cd build
    - cmake ..
    - make
  only:
    changes:
      - emulation/**
      - .gitlab-ci.yml
  artifacts:
    paths:
      - emulation/example/build/aurora_emu_example

emu:xrt:
  stage: emulation
  dependencies:
    - build:host
    - build:emulation_xclbin
  needs: ["build:emulation_xclbin", "build:host"]
  script:
    - env XCL_EMULATION_MODE=sw_emu ./host_aurora_hls_test -p aurora_hls_test_sw_emu.xclbin -b 256 -i 20 -f 1

emu:hlslib_test:
  stage: emulation
  dependencies:
    - build:hlslib_test
  needs: ["build:hlslib_test"]
  script:
    - cd emulation/test/build
    - ./aurora_emu_test

emu:hlslib_example:
  stage: emulation
  dependencies:
    - build:hlslib_example
  needs: ["build:hlslib_example"]
  script:
    - cd emulation/example/build
    - ./aurora_emu_example

synth:streaming:2.15:
  stage: synth
  variables:
    SCHEDULER_PARAMETERS: $SYNTH_SCHEDULER_PARAMETERS
  script:
    make xclbin USE_FRAMING=0
    cp aurora_hls_test_hw.xclbin aurora_hls_test_hw_streaming.xclbin
  only:
    - web 
  artifacts:
    paths:
      - aurora_hls_test_hw_streaming.xclbin
  needs: ["emu:xrt", "emu:hlslib_test", "emu:hlslib_example"]

synth:framing:2.15:
  stage: synth
  variables:
    SCHEDULER_PARAMETERS: $SYNTH_SCHEDULER_PARAMETERS
  script:
    make xclbin USE_FRAMING=1
  only:
    - web 
  artifacts:
    paths:
      - aurora_hls_test_hw.xclbin
  needs: ["emu:xrt", "emu:hlslib_test", "emu:hlslib_example"]

synth:streaming:2.14:
  stage: synth
  variables:
    SCHEDULER_PARAMETERS: $SYNTH_SCHEDULER_PARAMETERS
  script:
    ml fpga/xilinx/xrt/2.14
    make xclbin USE_FRAMING=0
    cp aurora_hls_test_hw.xclbin aurora_hls_test_hw_streaming.xclbin
  only:
    - web 
  artifacts:
    paths:
      - aurora_hls_test_hw_streaming.xclbin
  needs: ["emu:xrt", "emu:hlslib_test", "emu:hlslib_example"]

synth:framing:2.14:
  stage: synth
  variables:
    SCHEDULER_PARAMETERS: $SYNTH_SCHEDULER_PARAMETERS
  script:
    ml fpga/xilinx/xrt/2.14
    make xclbin USE_FRAMING=1
  only:
    - web 
  artifacts:
    paths:
      - aurora_hls_test_hw.xclbin
  needs: ["emu:xrt", "emu:hlslib_test", "emu:hlslib_example"]

synth:streaming:2.16:
  stage: synth
  variables:
    SCHEDULER_PARAMETERS: $SYNTH_SCHEDULER_PARAMETERS
  script:
    ml fpga/xilinx/xrt/2.16
    make xclbin USE_FRAMING=0
    cp aurora_hls_test_hw.xclbin aurora_hls_test_hw_streaming.xclbin
  only:
    - web 
  artifacts:
    paths:
      - aurora_hls_test_hw_streaming.xclbin
  needs: ["emu:xrt", "emu:hlslib_test", "emu:hlslib_example"]

synth:framing:2.16:
  stage: synth
  variables:
    SCHEDULER_PARAMETERS: $SYNTH_SCHEDULER_PARAMETERS
  script:
    ml fpga/xilinx/xrt/2.16
    make xclbin USE_FRAMING=1
  only:
    - web 
  artifacts:
    paths:
      - aurora_hls_test_hw.xclbin
  needs: ["emu:xrt", "emu:hlslib_test", "emu:hlslib_example"]